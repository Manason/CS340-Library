<!DOCTYPE HTML>

<html>
<head>
	<title>Library Catalog</title>
	<link type="text/css" rel="stylesheet" href="/css/index.css">
	<script src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h1>Library Catalog</h1>
<ul id="nav">
	<li><a href="/donate/book">Donate Book</a></li>
	<li><a href="/donate/film">Donate Film</a></li>
	<li><a href="/signup">Sign Up</a></li>
</ul>

<main>
	<div id="mediaOverlay" class="hidden">
		<div id="overlayCanvas">
			<h2 id="mediaTitle"></h2>
			<h3 id="mediaCreator"></h4>
			<span id="mediaCopies"></span><br>
			<span id="mediaType"></span><br>
			<span id="avgRating"></span><br><hr><hr>
			<div id="reviews"></div>
		</div>
	</div>
	
</main>


<script src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
<script>
	var socket = io();
	socket.emit('getCatalog');
	socket.on('catalog',function(data){
		data.forEach(function(item){
			var data = {mediaID: item.mediaID, type : item.type};
				socket.emit('getMedia',data);
		});
	});
	socket.on('media',function(item){
		var cover = $('<img>').addClass('listingImage').attr('src',item[0].imageURL);
		var title = $('<li/>').addClass('listingTitle').text(item[0].title);
		var creator;
		if(item[0].author!=null){
			creator = $('<li/>').addClass('listingCreator').text(item[0].author);
		} else if(item[0].director!=null){
			creator = $('<li/>').addClass('listingCreator').text(item[0].director);
		}
		var section = $('<li/>').addClass('listingSection').text(item[0].sectionName);
		var type = $('<span/>').addClass('listingType').text(item[0].type);
		var info = $('<ul/>').addClass('listingText').append(title,creator,section);
		var listingLink = $('<a/>').addClass('mediaLink').append(cover,info,type);
		var listing = $('<div/>').addClass('listing').append(listingLink);
		$('main').append(listing);
	});
	$('main').bind("click","a", function(event){
		if($('#mediaOverlay').hasClass('hidden')){
			var container = $(event.target);
			while(!container.is("div")){
				container = container.parent();
			}
			if(container.hasClass('listing')){
				var mediaTitle = container.find('.listingTitle').text();
				var mediaCreator = container.find('.listingCreator').text();
				var mediaType = container.find('.listingType').text();
				
				//Might want to change this to go to another page instead?
				var data = {title : mediaTitle, creator : mediaCreator, type : mediaType}
				socket.emit('getInfo',data);
			}
		}
	});
	$('#mediaOverlay').bind("click", function(event){
		if($(event.target).attr('id')=='mediaOverlay'){
			$('#mediaOverlay').removeClass('overlay').addClass('hidden');
			$('.coverImage').remove();
			$('#reviews').empty();
		}
	});
	socket.on('mediaInfo',function(data){
		$('#mediaTitle').text(data.title);
		$('<img/>').addClass('mediaImage').attr('src',data.imageURL).insertBefore( $('#mediaTitle') );
		$('#mediaCreator').text(data.creator);
		$('#mediaCopies').text("Copies: "+data.copies);
		$('#mediaType').text("Type: "+data.type);
		data.reviews.forEach(function(item){
			var review = $('<div/>').addClass('reviewEntry');
			var reviewer = $('<span/>').addClass('reviewer').text(item.userID);
			var rating = $('<span/>').addClass('rating').text(item.rating);
			var description = $('<p/>').addClass('description').text(item.description);
			review.append(reviewer,rating,description);
			$('#reviews').append(review,$('<hr>'));
		});
		var total=0; var count=0;
		$('.rating').each(function(){
			total+=parseInt($(this).text());
			count+=1;
		});
		$('#avgRating').text("Average Rating: "+(total/count).toFixed(1).toString());
		$('#mediaOverlay').removeClass('hidden').addClass('overlay')
	});
</script>
</body>
</html>


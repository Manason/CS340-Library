<!DOCTYPE HTML>

<html>
<head>
	<title>Library</title>
	<link type="text/css" rel="stylesheet" href="/css/index.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<script src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h1>Library</h1>
<ul id="nav">
	<li><a href="/">Catalog</a></li>
	<li><a href="/donate/book">Donate Book</a></li>
	<li><a href="/donate/film">Donate Film</a></li>
	<li><a href="/signup">Sign Up</a></li>
	
</ul>

	<input id="catalogSearch" class="searchBox" placeholder="Search">

<main>
	
	<div id="listings">
	</div>
	
	
</main>


<script src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
<script>
	var socket = io();
	socket.emit('getCatalog');
	socket.on('catalog',function(data){
		data.forEach(function(item){
			var data = {mediaID: item.mediaID, type : item.type};
				socket.emit('getMedia',data);
		});
	});
	socket.on('media',function(item){
		var cover = $('<img>').addClass('listingImage').attr('src',item[0].imageURL);
		var title = $('<li/>').addClass('listingTitle').text(item[0].title);
		var creator;
		if(item[0].author!=null){
			creator = $('<li/>').addClass('listingCreator').text(item[0].author);
		} else if(item[0].director!=null){
			creator = $('<li/>').addClass('listingCreator').text(item[0].director);
		}
		var section = $('<li/>').addClass('listingSection').text(item[0].sectionName);
		var typeIcon = $('<i/>').addClass('material-icons listingType').html('book');
		if(item[0].type=='film'){
			typeIcon = $('<i/>').addClass('material-icons listingType').html('movies');
		}
		var info = $('<ul/>').addClass('listingText').append(title,creator,section);
		var listingLink = $('<span/>').addClass('mediaLink').append(cover,typeIcon,info);
		var listing = $('<div/>').addClass('listing').append(listingLink);
		$('#listings').append(listing);
	});
	$('main').bind("click","a", function(event){
			var container = $(event.target);
			while(!container.is("div")){
				container = container.parent();
			}
			if(container.hasClass('listing')){
				var mediaTitle = container.find('.listingTitle').text();
				var mediaCreator = container.find('.listingCreator').text();
				var mediaType = container.find('.listingType').text();
				if(mediaType=='movies') mediaType='film';
				
				//Might want to change this to go to another page instead?
				var data = {title : mediaTitle, creator : mediaCreator, type : mediaType}
				socket.emit('getInfo',data);
			}
	});
	socket.on('mediaInfo',function(data){
		var backButton = $('<button/>').addClass('backButton').text('<');
		backButton.click(function(){
			$('.bigMedia').remove();
			$('#listings').removeClass('hidden');
			$('#catalogSearch').removeClass('hidden');
		});
		var mediaTitle = $('<h2/>').addClass('mediaTitle').text(data.title);
		var mediaImg = $('<img>').addClass('mediaImg').addClass('mediaImage').attr('src',data.imageURL);
		var mediaCreator = $('<h3/>').addClass('mediaCreator').text(data.creator);
		var mediaCopies = $('<p/>').addClass('mediaCopies').text("Copies: "+data.copies);
		var mediaType = $('<p/>').addClass('mediaType').text("Type: "+data.type);
		var reviews = $('<div/>').addClass('reviews');
		var ratings = []
		data.reviews.forEach(function(item){
			var review = $('<div/>').addClass('reviewEntry');
			var reviewer = $('<span/>').addClass('reviewer').text(item.userID);
			var rating = $('<span/>').addClass('rating').text(item.rating);
			ratings.push(item.rating);
			var description = $('<p/>').addClass('description').text(item.description);
			review.append(reviewer,rating,description);
			reviews.append(review,$('<hr>'));
		});
		var total=0; var count=0;
		ratings.forEach(function(val){
			total+=parseInt(val);
			count+=1;
		});
		var bigMedia = $('<div/>').addClass('bigMedia').append(backButton,mediaImg,mediaTitle,mediaCreator,mediaCopies,mediaType,reviews);
		$('#listings').addClass('hidden');
		$('#catalogSearch').addClass('hidden');
		$('main').append(bigMedia);
	});
</script>
</body>
</html>

